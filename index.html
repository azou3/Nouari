<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù…ÙŠ Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ… Ø­Ù…Ø²Ø© Ø±Ø­Ù…Ù‡ Ø§Ù„Ù„Ù‡</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@700&family=Orbitron:wght@400..900&display=swap" rel="stylesheet">
    
    <!-- PWA Manifest & Theme -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#1a0505"/>

    <style>
        .digital-font { font-family: 'Orbitron', sans-serif; font-weight: 700; }
        .arabic-font { font-family: 'Cairo', sans-serif; font-weight: 700; }
        .red-glow { color: #ff6b6b; text-shadow: 0 0 5px #ff0000, 0 0 10px #ff0000; }
        .yellow-glow { color: #ffee80; text-shadow: 0 0 5px #ffc700, 0 0 10px #ffc700; }
        .green-glow { color: #80ff80; text-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00; }
        body { background-color: #000; background-image: linear-gradient(145deg, #1d0202 0%, #000000 74%); background-attachment: fixed; }
        .clock-container { position: relative; background-image: url('https://images.unsplash.com/photo-1581989732188-75915b82c518?w=800&q=80'); background-size: cover; background-position: center; border: 4px solid #8c5319; box-shadow: 0 0 25px rgba(0,0,0,0.8), inset 0 0 20px rgba(0,0,0,0.7); overflow: hidden; }
        .clock-container::before { content: ''; position: absolute; inset: 0; background-color: rgba(42, 8, 8, 0.75); z-index: 1; }
        .clock-content { position: relative; z-index: 2; }
        .prayer-row, .info-box { background-color: rgba(100, 20, 20, 0.7); border: 1px solid rgba(255, 150, 150, 0.2); backdrop-filter: blur(2px); box-shadow: inset 0 0 8px rgba(0,0,0,0.6); }
        #status-message { color: #ffd700; text-align: center; padding: 10px; font-size: 1.1rem; }
        .modal-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.7); z-index: 40; backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; }
        .modal-panel { z-index: 50; background-color: #1a0505; border: 2px solid #8c5319; }
        .form-input, .form-select { background-color: #333; border: 1px solid #666; color: white; }
        .btn { background-color: #8c5319; color: white; transition: background-color 0.2s; }
        .btn:hover { background-color: #a8641e; }
        .btn-secondary { background-color: #555; }
        .btn-secondary:hover { background-color: #777; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- Main Clock -->
    <div class="clock-container max-w-sm w-full mx-auto rounded-2xl">
        <div class="clock-content p-4">
            <h1 class="arabic-font text-2xl text-center mb-2 red-glow">ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù…ÙŠ Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ… Ø­Ù…Ø²Ø© Ø±Ø­Ù…Ù‡ Ø§Ù„Ù„Ù‡</h1>
            <p id="location-name" class="arabic-font text-sm text-center text-amber-300 mb-4">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª...</p>
            <div class="digital-font text-center text-5xl mb-3" id="current-time">--:--:--</div>
            <div class="digital-font text-center text-xl mb-1" id="gregorian-date">----.--.--</div>
            <div class="digital-font text-center text-xl mb-4" id="hijri-date">----.--.--</div>
            <div id="status-message" class="arabic-font hidden"></div>
            <div id="prayer-times-container" class="space-y-2 text-3xl">
                <div class="prayer-row flex justify-between items-center p-2 rounded-lg"><span class="arabic-font red-glow">Ø§Ù„ÙØ¬Ø±</span><span class="digital-font" id="fajr-time">--:--</span></div>
                <div class="prayer-row flex justify-between items-center p-2 rounded-lg"><span class="arabic-font red-glow">Ø§Ù„Ø´Ø±ÙˆÙ‚</span><span class="digital-font" id="sunrise-time">--:--</span></div>
                <div class="prayer-row flex justify-between items-center p-2 rounded-lg"><span class="arabic-font red-glow">Ø§Ù„Ø¸Ù‡Ø±</span><span class="digital-font" id="dhuhr-time">--:--</span></div>
                <div class="prayer-row flex justify-between items-center p-2 rounded-lg"><span class="arabic-font red-glow">Ø§Ù„Ø¹ØµØ±</span><span class="digital-font" id="asr-time">--:--</span></div>
                <div class="prayer-row flex justify-between items-center p-2 rounded-lg"><span class="arabic-font red-glow">Ø§Ù„Ù…ØºØ±Ø¨</span><span class="digital-font" id="maghrib-time">--:--</span></div>
                <div class="prayer-row flex justify-between items-center p-2 rounded-lg"><span class="arabic-font red-glow">Ø§Ù„Ø¹Ø´Ø§Ø¡</span><span class="digital-font" id="isha-time">--:--</span></div>
            </div>
            <div class="mt-4 flex justify-between items-center space-x-2 rtl:space-x-reverse">
                <div class="info-box text-center p-2 rounded-lg flex-grow"><div class="arabic-font text-sm red-glow" id="upcoming-prayer-name">...</div><div class="digital-font text-3xl" id="upcoming-prayer-time">--:--</div></div>
                <div class="info-box text-center p-2 rounded-lg"><div class="arabic-font text-sm red-glow">Ø§Ù„Ø­Ø±Ø§Ø±Ø©</div><div class="digital-font text-3xl"><span id="temp-value">28</span>Â°C</div></div>
            </div>
        </div>
    </div>

    <!-- Settings Icon -->
    <div id="settings-icon" class="fixed bottom-4 right-4 cursor-pointer z-30"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#ffee80" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg></div>

    <!-- Install App Panel -->
    <div id="install-panel" class="modal-overlay hidden"><div class="modal-panel w-full max-w-sm p-6 rounded-lg shadow-lg text-white text-center"><h2 class="text-2xl arabic-font red-glow mb-4">ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</h2><p class="mb-6">Ù„Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹ØŒ Ù‚Ù… Ø¨ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ Ø´Ø§Ø´ØªÙƒ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©.</p><button id="install-btn" class="btn w-full py-2 px-4 rounded mb-3">ØªØ«Ø¨ÙŠØª Ø§Ù„Ø¢Ù†</button><button id="install-later-btn" class="text-gray-400 hover:text-white">Ù„ÙŠØ³ Ø§Ù„Ø¢Ù†</button></div></div>

    <!-- First Time Setup Panel -->
    <div id="setup-panel" class="modal-overlay hidden"><div class="modal-panel w-full max-w-sm p-6 rounded-lg shadow-lg text-white text-center"><h2 class="text-2xl arabic-font red-glow mb-4">Ø¥Ø¹Ø¯Ø§Ø¯ Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©</h2><p class="mb-6">Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£ÙØ¶Ù„ ØªØ¬Ø±Ø¨Ø©ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙˆØ§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ.</p><button id="enable-notifications-btn" class="btn w-full py-2 px-4 rounded mb-3">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙˆØ§Ù„Ø£Ø°Ø§Ù†</button><button id="setup-later-btn" class="text-gray-400 hover:text-white">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ù„Ø§Ø­Ù‚Ø§Ù‹</button></div></div>
    
    <!-- Login Panel -->
    <div id="login-panel" class="modal-overlay hidden"><div class="modal-panel w-full max-w-sm p-6 rounded-lg shadow-lg"><h2 class="text-2xl text-center arabic-font red-glow mb-4">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2><form id="login-form"><input type="text" id="username" class="form-input w-full p-2 rounded mb-4" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"><input type="password" id="password" class="form-input w-full p-2 rounded mb-6" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"><p id="login-error" class="text-red-500 text-center mb-4 hidden">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©.</p><div class="flex items-center justify-between"><button type="submit" class="btn w-full py-2 px-4 rounded">Ø¯Ø®ÙˆÙ„</button><button type="button" id="close-login" class="text-gray-400 hover:text-white ml-4">Ø¥ØºÙ„Ø§Ù‚</button></div></form></div></div>
    
    <!-- Adhan Notification Panel -->
    <div id="adhan-panel" class="modal-overlay hidden"><div class="modal-panel w-full max-w-md p-8 rounded-lg shadow-lg text-white text-center"><h2 id="adhan-title" class="text-4xl arabic-font yellow-glow mb-6">Ø­Ø§Ù† Ø§Ù„Ø¢Ù† ÙˆÙ‚Øª ØµÙ„Ø§Ø©...</h2><p id="adhan-repeat-counter" class="text-lg text-gray-300 mb-4"></p><button id="close-adhan-btn" class="btn w-1/2 py-2 px-4 rounded">Ø¥ØºÙ„Ø§Ù‚</button></div></div>

    <!-- Settings Panel -->
    <div id="settings-panel" class="modal-overlay hidden"><div class="modal-panel w-full max-w-sm p-6 rounded-lg shadow-lg"><h2 class="text-2xl text-center arabic-font red-glow mb-6">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2><div class="mb-4"><label class="block text-amber-300 mb-2 arabic-font">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹</label><div class="flex space-x-2 rtl:space-x-reverse"><select id="city-select" class="form-select w-full p-2 rounded"></select><button id="gps-btn" class="btn btn-secondary p-2 rounded" title="ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¢Ù„ÙŠØ§Ù‹"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"></path><circle cx="12" cy="10" r="3"></circle></svg></button></div><p id="gps-status" class="text-xs text-center text-gray-400 mt-2"></p></div><div class="mb-4"><label for="method-select" class="block text-amber-300 mb-2 arabic-font">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø­Ø³Ø§Ø¨</label><select id="method-select" class="form-select w-full p-2 rounded"></select></div><div class="mb-4"><label for="pre-notification-time" class="block text-amber-300 mb-2 arabic-font">ØªÙ†Ø¨ÙŠÙ‡ Ù‚Ø¨Ù„ Ø§Ù„Ø£Ø°Ø§Ù† Ø¨Ù€ (Ø¯Ù‚Ø§Ø¦Ù‚)</label><input type="number" id="pre-notification-time" class="form-input w-full p-2 rounded" min="0" max="60"></div><div class="mb-4"><label for="adhan-repeats" class="block text-amber-300 mb-2 arabic-font">ØªÙƒØ±Ø§Ø± Ø§Ù„Ø£Ø°Ø§Ù† (Ù…Ø±Ø§Øª)</label><input type="number" id="adhan-repeats" class="form-input w-full p-2 rounded" min="1" max="5" value="1"></div><div class="mb-4"><label class="block text-amber-300 mb-2 arabic-font">ØµÙˆØª Ø§Ù„Ø£Ø°Ø§Ù†</label><input type="file" id="adhan-file-input" class="text-white w-full" accept="audio/*"><p id="adhan-file-name" class="text-xs text-gray-400 mt-1"></p></div><div class="mb-6"><label class="block text-amber-300 mb-2 arabic-font">Ù„ÙˆÙ† Ø§Ù„Ø£Ø±Ù‚Ø§Ù…</label><div class="flex justify-around"><label class="flex items-center"><input type="radio" name="color" value="yellow-glow" class="ml-2"> <span class="yellow-glow">Ø£ØµÙØ±</span></label><label class="flex items-center"><input type="radio" name="color" value="red-glow" class="ml-2"> <span class="red-glow">Ø£Ø­Ù…Ø±</span></label><label class="flex items-center"><input type="radio" name="color" value="green-glow" class="ml-2"> <span class="green-glow">Ø£Ø®Ø¶Ø±</span></label></div></div><div class="flex items-center justify-between"><button id="save-settings" class="btn py-2 px-4 rounded">Ø­ÙØ¸ ÙˆØ¥ØºÙ„Ø§Ù‚</button><button id="close-settings" class="text-gray-400 hover:text-white">Ø¥Ù„ØºØ§Ø¡</button></div></div></div>
    
    <audio id="adhan-player" class="hidden"></audio>

    <script>
    const dom = {
        currentTime: document.getElementById('current-time'), gregorianDate: document.getElementById('gregorian-date'), hijriDate: document.getElementById('hijri-date'), allDigitalElements: document.querySelectorAll('.digital-font'), statusMessage: document.getElementById('status-message'), prayerTimesContainer: document.getElementById('prayer-times-container'), locationName: document.getElementById('location-name'), settingsIcon: document.getElementById('settings-icon'), loginPanel: document.getElementById('login-panel'), settingsPanel: document.getElementById('settings-panel'), loginForm: document.getElementById('login-form'), loginError: document.getElementById('login-error'), closeLoginBtn: document.getElementById('close-login'), closeSettingsBtn: document.getElementById('close-settings'), citySelect: document.getElementById('city-select'), methodSelect: document.getElementById('method-select'), saveSettingsBtn: document.getElementById('save-settings'), gpsBtn: document.getElementById('gps-btn'), gpsStatus: document.getElementById('gps-status'), preNotificationTime: document.getElementById('pre-notification-time'), adhanFileInput: document.getElementById('adhan-file-input'), adhanFileName: document.getElementById('adhan-file-name'), adhanPlayer: document.getElementById('adhan-player'), setupPanel: document.getElementById('setup-panel'), enableNotificationsBtn: document.getElementById('enable-notifications-btn'), setupLaterBtn: document.getElementById('setup-later-btn'), adhanPanel: document.getElementById('adhan-panel'), adhanTitle: document.getElementById('adhan-title'), closeAdhanBtn: document.getElementById('close-adhan-btn'), installPanel: document.getElementById('install-panel'), installBtn: document.getElementById('install-btn'), installLaterBtn: document.getElementById('install-later-btn'), adhanRepeats: document.getElementById('adhan-repeats'), adhanRepeatCounter: document.getElementById('adhan-repeat-counter')
    };
    const algerianWilayas = ["Adrar","Chlef","Laghouat","Oum El Bouaghi","Batna","BÃ©jaÃ¯a","Biskra","BÃ©char","Blida","Bouira","Tamanrasset","TÃ©bessa","Tlemcen","Tiaret","Tizi Ouzou","Algiers","Djelfa","Jijel","SÃ©tif","SaÃ¯da","Skikda","Sidi Bel AbbÃ¨s","Annaba","Guelma","Constantine","MÃ©dÃ©a","Mostaganem","M'Sila","Mascara","Ouargla","Oran","El Bayadh","Illizi","Bordj Bou ArrÃ©ridj","BoumerdÃ¨s","El Tarf","Tindouf","Tissemsilt","El Oued","Khenchela","Souk Ahras","Tipaza","Mila","AÃ¯n Defla","NaÃ¢ma","AÃ¯n TÃ©mouchent","GhardaÃ¯a","Relizane","Timimoun","Bordj Badji Mokhtar","Ouled Djellal","BÃ©ni AbbÃ¨s","In Salah","In Guezzam","Touggourt","Djanet","El M'Ghair","El Meniaa"];
    const calculationMethods = [{ id: 3, name: 'Ø±Ø§Ø¨Ø·Ø© Ø§Ù„Ø¹Ø§Ù„Ù… Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠ (MWL)' }, { id: 5, name: 'Ø§Ù„Ù‡ÙŠØ¦Ø© Ø§Ù„Ù…ØµØ±ÙŠØ© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„Ù…Ø³Ø§Ø­Ø©' }, { id: 8, name: 'ÙˆØ²Ø§Ø±Ø© Ø§Ù„Ø´Ø¤ÙˆÙ† Ø§Ù„Ø¯ÙŠÙ†ÙŠØ© Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±ÙŠØ©' }, { id: 4, name: 'Ø£Ù… Ø§Ù„Ù‚Ø±Ù‰ØŒ Ù…ÙƒØ© Ø§Ù„Ù…ÙƒØ±Ù…Ø©' }, { id: 2, name: 'Ø§Ù„Ù…Ø¬ØªÙ…Ø¹ Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠ Ù„Ø£Ù…Ø±ÙŠÙƒØ§ Ø§Ù„Ø´Ù…Ø§Ù„ÙŠØ© (ISNA)'}];
    const prayerNameMapping = { Fajr: 'Ø§Ù„ÙØ¬Ø±', Dhuhr: 'Ø§Ù„Ø¸Ù‡Ø±', Asr: 'Ø§Ù„Ø¹ØµØ±', Maghrib: 'Ø§Ù„Ù…ØºØ±Ø¨', Isha: 'Ø§Ù„Ø¹Ø´Ø§Ø¡' };
    let prayerTimesData = {};
    let currentSettings = { city: 'Algiers', color: 'yellow-glow', method: 3, preNotificationMins: 10, adhanRepeats: 1 };
    let mainInterval;
    let adhanRepeatInterval;
    let deferredPrompt;

    async function fetchPrayerTimes(settings) {
        dom.statusMessage.textContent = `Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ù‚ÙŠØª...`;
        dom.statusMessage.classList.remove('hidden');
        dom.prayerTimesContainer.classList.add('hidden');
        let apiUrl;
        if (settings.lat && settings.lon) {
            apiUrl = `https://api.aladhan.com/v1/timings?latitude=${settings.lat}&longitude=${settings.lon}&method=${settings.method}`;
        } else {
            apiUrl = `https://api.aladhan.com/v1/timingsByCity?city=${settings.city}&country=Algeria&method=${settings.method}`;
        }
        try {
            const response = await fetch(apiUrl);
            if (!response.ok) throw new Error(`Network Error: ${response.statusText}`);
            const data = await response.json();
            if (data.code !== 200) throw new Error(`API Error: ${data.status}`);
            prayerTimesData = data.data.timings;
            const date = data.data.date;
            ['Fajr', 'Sunrise', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'].forEach(p => {
                document.getElementById(p.toLowerCase() + '-time').textContent = prayerTimesData[p];
            });
            dom.gregorianDate.textContent = `${date.gregorian.year}.${date.gregorian.month.number}.${date.gregorian.day}`;
            dom.hijriDate.textContent = `${date.hijri.year}.${date.hijri.month.number}.${date.hijri.day}`;
            dom.locationName.textContent = settings.city ? `Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø© Ù„Ù€ ${settings.city}` : 'Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­Ø¯Ø¯ Ø¢Ù„ÙŠØ§Ù‹';
            dom.statusMessage.classList.add('hidden');
            dom.prayerTimesContainer.classList.remove('hidden');
            updateUpcomingPrayer();
        } catch (error) {
            dom.statusMessage.textContent = 'ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.';
            console.error("Fetch Error:", error);
        }
    }

    function mainLoop() {
        const now = new Date();
        dom.currentTime.textContent = now.toLocaleTimeString('en-GB');
        updateUpcomingPrayer();
        checkAndNotify(now);
    }
    
    function updateUpcomingPrayer() {
        if (Object.keys(prayerTimesData).length === 0) return;
        const now = new Date();
        const currentTime = now.getHours() * 60 + now.getMinutes();
        const prayerSchedule = ['Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'].map(p => ({name: p, time: prayerTimesData[p]}));
        let nextPrayer = prayerSchedule.find(p => (parseInt(p.time.split(':')[0]) * 60 + parseInt(p.time.split(':')[1])) > currentTime);
        if (!nextPrayer) nextPrayer = prayerSchedule[0];
        document.getElementById('upcoming-prayer-name').textContent = prayerNameMapping[nextPrayer.name];
        document.getElementById('upcoming-prayer-time').textContent = nextPrayer.time;
    }
    
    function checkAndNotify(now) {
        if (Object.keys(prayerTimesData).length === 0) return;
        const todayStr = now.toISOString().split('T')[0];
        const prayerSchedule = ['Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];

        prayerSchedule.forEach(prayerName => {
            const prayerTimeStr = prayerTimesData[prayerName];
            if (!prayerTimeStr) return;
            
            const [hours, minutes] = prayerTimeStr.split(':').map(Number);
            const prayerDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes);
            
            const preNotifKey = `pre_${prayerName}_${todayStr}`;
            if (currentSettings.preNotificationMins > 0) {
                const preAdhanDate = new Date(prayerDate.getTime() - currentSettings.preNotificationMins * 60000);
                if (now >= preAdhanDate && now < prayerDate && !localStorage.getItem(preNotifKey)) {
                    sendBackgroundNotification(`ØµÙ„Ø§Ø© ${prayerNameMapping[prayerName]} Ø¨Ø¹Ø¯ ${currentSettings.preNotificationMins} Ø¯Ù‚Ø§Ø¦Ù‚`, { body: `Ø§Ø³ØªØ¹Ø¯ Ù„Ù„ØµÙ„Ø§Ø©` });
                    localStorage.setItem(preNotifKey, 'true');
                }
            }

            const adhanNotifKey = `adhan_${prayerName}_${todayStr}`;
            if (now >= prayerDate && now < new Date(prayerDate.getTime() + 60000) && !localStorage.getItem(adhanNotifKey)) {
                showAdhanScreen(prayerNameMapping[prayerName]);
                localStorage.setItem(adhanNotifKey, 'true');
            }
        });
    }
    
    function sendBackgroundNotification(title, options) {
        if ('Notification' in window && Notification.permission === 'granted') {
             navigator.serviceWorker.ready.then(registration => {
                registration.showNotification(title, {
                    body: options.body,
                    icon: 'https://placehold.co/192x192/8c5319/ffee80?text=ğŸ•Œ',
                    vibrate: [200, 100, 200]
                });
            });
        }
    }

    function showAdhanScreen(prayerName) {
        dom.adhanTitle.textContent = `Ø­Ø§Ù† Ø§Ù„Ø¢Ù† ÙˆÙ‚Øª ØµÙ„Ø§Ø© ${prayerName}`;
        dom.adhanPanel.classList.remove('hidden');
        
        const adhanSound = localStorage.getItem('adhanSound');
        if (!adhanSound) return;

        let repeatCount = currentSettings.adhanRepeats || 1;
        dom.adhanRepeatCounter.textContent = `(Ø§Ù„ØªÙƒØ±Ø§Ø± ${repeatCount} Ù…Ù† ${currentSettings.adhanRepeats})`;

        const playAdhan = () => {
            dom.adhanPlayer.src = adhanSound;
            dom.adhanPlayer.play().catch(e => console.error("Audio play failed:", e));
        };
        
        playAdhan(); // Play first time immediately
        repeatCount--;

        if (repeatCount > 0) {
            adhanRepeatInterval = setInterval(() => {
                if (repeatCount <= 0) {
                    clearInterval(adhanRepeatInterval);
                    return;
                }
                playAdhan();
                repeatCount--;
                dom.adhanRepeatCounter.textContent = `(Ø§Ù„ØªÙƒØ±Ø§Ø± ${currentSettings.adhanRepeats - repeatCount} Ù…Ù† ${currentSettings.adhanRepeats})`;
            }, 60000); // Repeat every minute
        }
    }

    function applyColor(colorClass) {
        dom.allDigitalElements.forEach(el => {
            el.classList.remove('yellow-glow', 'red-glow', 'green-glow');
            el.classList.add(colorClass);
        });
    }

    function saveSettings() {
        currentSettings.color = document.querySelector('input[name="color"]:checked').value;
        currentSettings.method = parseInt(dom.methodSelect.value);
        currentSettings.preNotificationMins = parseInt(dom.preNotificationTime.value) || 0;
        currentSettings.adhanRepeats = parseInt(dom.adhanRepeats.value) || 1;
        
        if (dom.citySelect.dataset.mode === 'manual') {
             currentSettings.city = dom.citySelect.value;
             delete currentSettings.lat;
             delete currentSettings.lon;
        }
        
        localStorage.setItem('prayerClockSettings', JSON.stringify(currentSettings));
        applyColor(currentSettings.color);
        fetchPrayerTimes(currentSettings);
        dom.settingsPanel.classList.add('hidden');
    }

    function loadSettings() {
        const savedSettings = localStorage.getItem('prayerClockSettings');
        if (savedSettings) {
            currentSettings = JSON.parse(savedSettings);
        }
        const savedAdhanName = localStorage.getItem('adhanSoundName');
        if(savedAdhanName) dom.adhanFileName.textContent = `Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø­Ø§Ù„ÙŠ: ${savedAdhanName}`;

        applyColor(currentSettings.color);
        fetchPrayerTimes(currentSettings);
    }

    function populateDropdowns() {
        algerianWilayas.forEach(city => dom.citySelect.add(new Option(city, city)));
        calculationMethods.forEach(method => dom.methodSelect.add(new Option(method.name, method.id)));
    }
    
    function openSettingsPanel() {
        dom.citySelect.dataset.mode = 'manual';
        if (currentSettings.city) dom.citySelect.value = currentSettings.city;
        dom.methodSelect.value = currentSettings.method;
        dom.preNotificationTime.value = currentSettings.preNotificationMins;
        dom.adhanRepeats.value = currentSettings.adhanRepeats;
        document.querySelector(`input[name="color"][value="${currentSettings.color}"]`).checked = true;
        dom.gpsStatus.textContent = '';
        dom.settingsPanel.classList.remove('hidden');
    }

    function handleLogin(event) {
        event.preventDefault();
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        if (username === 'azouze' && password === '19891989') {
            dom.loginPanel.classList.add('hidden');
            dom.loginError.classList.add('hidden');
            document.getElementById('login-form').reset();
            openSettingsPanel();
        } else {
            dom.loginError.classList.remove('hidden');
        }
    }

    function handleGpsRequest() {
        if (!navigator.geolocation) {
            dom.gpsStatus.textContent = 'Ø®Ø§ØµÙŠØ© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø©.';
            return;
        }
        dom.gpsStatus.textContent = 'Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹...';
        navigator.geolocation.getCurrentPosition(
            (position) => {
                dom.gpsStatus.textContent = 'ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ù†Ø¬Ø§Ø­!';
                dom.citySelect.dataset.mode = 'gps';
                currentSettings.lat = position.coords.latitude;
                currentSettings.lon = position.coords.longitude;
                delete currentSettings.city;
                saveSettings();
            },
            (error) => {
                let message = 'Ø­Ø¯Ø« Ø®Ø·Ø£.';
                if (error.code === 1) message = 'ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø¥Ø°Ù†. Ø§Ø®ØªØ± Ù…Ø¯ÙŠÙ†Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹.';
                dom.gpsStatus.textContent = message;
            }
        );
    }
    
    function handleAdhanFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                localStorage.setItem('adhanSound', e.target.result);
                localStorage.setItem('adhanSoundName', file.name);
                dom.adhanFileName.textContent = `Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø­Ø¯Ø¯: ${file.name}`;
            } catch (err) {
                alert('ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù. Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø­Ø¬Ù…Ù‡ ÙƒØ¨ÙŠØ±Ø§Ù‹ Ø¬Ø¯Ø§Ù‹.');
                console.error(err);
            }
        };
        reader.readAsDataURL(file);
    }

    function handleFirstTimeSetup() {
        if (localStorage.getItem('setupComplete')) return;
        dom.setupPanel.classList.remove('hidden');
        
        dom.enableNotificationsBtn.onclick = () => {
            // Unlock audio context
            dom.adhanPlayer.play().then(() => dom.adhanPlayer.pause()).catch(()=>{});
            
            Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                    alert('ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!');
                    localStorage.setItem('setupComplete', 'true');
                    dom.setupPanel.classList.add('hidden');
                } else {
                    alert('Ù„Ù… ÙŠØªÙ… Ù…Ù†Ø­ Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª. Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª.');
                }
            });
        };
        dom.setupLaterBtn.onclick = () => dom.setupPanel.classList.add('hidden');
    }

    // --- PWA & Service Worker Logic ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js').then(registration => {
                console.log('ServiceWorker registration successful with scope: ', registration.scope);
            }).catch(err => {
                console.log('ServiceWorker registration failed: ', err);
            });
        });
    }

    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        if(dom.installPanel) {
            dom.installPanel.classList.remove('hidden');
        }
    });

    if(dom.installBtn) {
        dom.installBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                await deferredPrompt.userChoice;
                deferredPrompt = null;
                dom.installPanel.classList.add('hidden');
            }
        });
    }

    if(dom.installLaterBtn) {
        dom.installLaterBtn.addEventListener('click', () => {
            dom.installPanel.classList.add('hidden');
        });
    }


    // --- Event Listeners & Initial Load ---
    dom.settingsIcon.addEventListener('click', () => dom.loginPanel.classList.remove('hidden'));
    dom.closeLoginBtn.addEventListener('click', () => dom.loginPanel.classList.add('hidden'));
    dom.loginForm.addEventListener('submit', handleLogin);
    dom.saveSettingsBtn.addEventListener('click', saveSettings);
    dom.closeSettingsBtn.addEventListener('click', () => dom.settingsPanel.classList.add('hidden'));
    dom.gpsBtn.addEventListener('click', handleGpsRequest);
    dom.adhanFileInput.addEventListener('change', handleAdhanFileSelect);
    dom.closeAdhanBtn.addEventListener('click', () => {
        dom.adhanPanel.classList.add('hidden');
        dom.adhanPlayer.pause();
        dom.adhanPlayer.currentTime = 0;
        if(adhanRepeatInterval) clearInterval(adhanRepeatInterval);
    });

    document.addEventListener('DOMContentLoaded', () => {
        handleFirstTimeSetup();
        populateDropdowns();
        loadSettings();
        if (!mainInterval) {
            mainInterval = setInterval(mainLoop, 1000); // Check every second
        }
    });
    </script>
</body>
</html>
